<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Center - Center Parcs ROI</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.2s ease-in-out; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .btn-filter { transition: all 0.2s; }
        .btn-filter.active { background-color: #10B981; color: white; border-color: #10B981; }
        
        /* Custom Range Slider for Simulator */
        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #10B981; cursor: pointer; margin-top: -6px; box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #E5E7EB; border-radius: 2px;
        }

        /* Checkbox custom style for Battle Plan */
        .task-checkbox:checked + div {
            text-decoration: line-through;
            color: #9CA3AF;
        }
        .task-checkbox:checked + div .badge-gain {
            background-color: #E5E7EB;
            color: #9CA3AF;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header & Controls -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3">
                    <div class="bg-green-100 p-2 rounded-lg text-green-600">
                        <i class="fas fa-chart-radar text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">PILOTAGE ROI <span class="text-green-600">EMRICK</span></h1>
                        <p class="text-xs text-gray-500">Donn√©es Consolild√©es 2019-2020 ‚Ä¢ Mise √† jour: Temps R√©el</p>
                    </div>
                </div>
                
                <!-- Market Filters & Views -->
                <div class="flex bg-gray-100 p-1 rounded-lg">
                    <button onclick="updateView('global')" id="btn-global" class="btn-filter active px-4 py-1.5 rounded-md text-sm font-semibold text-gray-600 hover:text-gray-900">Global</button>
                    <button onclick="updateView('france')" id="btn-france" class="btn-filter px-4 py-1.5 rounded-md text-sm font-semibold text-gray-600 hover:text-gray-900">France</button>
                    <button onclick="updateView('inter')" id="btn-inter" class="btn-filter px-4 py-1.5 rounded-md text-sm font-semibold text-gray-600 hover:text-gray-900">International</button>
                    <div class="w-px bg-gray-300 mx-1"></div>
                    <button onclick="updateView('plan')" id="btn-plan" class="btn-filter px-4 py-1.5 rounded-md text-sm font-bold text-indigo-600 hover:text-indigo-800 hover:bg-indigo-50"><i class="fas fa-chess-knight mr-2"></i>Plan de Bataille</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-6 space-y-6">

        <!-- KPI Cards Row (Always Visible) -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <!-- CA -->
            <div class="card p-4 border-t-4 border-red-500">
                <div class="flex justify-between">
                    <div>
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Chiffre d'Affaires</p>
                        <h3 class="text-2xl font-bold text-gray-800 mt-1" id="kpi-revenue">89,03 M‚Ç¨</h3>
                    </div>
                    <span class="text-red-500 bg-red-50 px-2 py-1 rounded text-xs font-bold h-fit">-7.5%</span>
                </div>
                <div class="mt-3 h-1 w-full bg-gray-100 rounded-full overflow-hidden">
                    <div class="h-full bg-red-500 w-[89%]"></div>
                </div>
                <p class="text-xs text-gray-400 mt-2">vs 96.28 M‚Ç¨ (N-1)</p>
            </div>

            <!-- Transactions -->
            <div class="card p-4 border-t-4 border-green-500">
                <div class="flex justify-between">
                    <div>
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Transactions</p>
                        <h3 class="text-2xl font-bold text-gray-800 mt-1" id="kpi-transactions">134 590</h3>
                    </div>
                    <span class="text-green-500 bg-green-50 px-2 py-1 rounded text-xs font-bold h-fit">+3.6%</span>
                </div>
                 <div class="mt-3 h-1 w-full bg-gray-100 rounded-full overflow-hidden">
                    <div class="h-full bg-green-500 w-[100%]"></div>
                </div>
                <p class="text-xs text-gray-400 mt-2">Volume record atteint</p>
            </div>

            <!-- Panier Moyen -->
            <div class="card p-4 border-t-4 border-orange-500">
                <div class="flex justify-between">
                    <div>
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Panier Moyen (AOV)</p>
                        <h3 class="text-2xl font-bold text-gray-800 mt-1" id="kpi-aov">661 ‚Ç¨</h3>
                    </div>
                    <span class="text-red-500 bg-red-50 px-2 py-1 rounded text-xs font-bold h-fit">-11%</span>
                </div>
                 <div class="mt-3 h-1 w-full bg-gray-100 rounded-full overflow-hidden">
                    <div class="h-full bg-orange-500 w-[85%]"></div>
                </div>
                <p class="text-xs text-gray-400 mt-2">Cible id√©ale: >720‚Ç¨</p>
            </div>

             <!-- ROI Status -->
             <div class="card p-4 border-t-4 border-indigo-500 bg-indigo-50">
                <div class="flex justify-between">
                    <div>
                        <p class="text-xs font-bold text-indigo-400 uppercase tracking-wider">Objectif Landes</p>
                        <h3 class="text-2xl font-bold text-indigo-900 mt-1">ROI > 4</h3>
                    </div>
                    <i class="fas fa-check-circle text-indigo-500 text-xl"></i>
                </div>
                <p class="text-xs text-indigo-700 mt-3 font-semibold">
                    1.6 M‚Ç¨ requis (1.9% du CA)
                </p>
                <p class="text-xs text-indigo-400 mt-1">Objectif largement couvert</p>
            </div>
        </div>

        <!-- ================= VIEW: DASHBOARD (Default) ================= -->
        <div id="view-dashboard" class="space-y-6">
            <!-- Middle Section: Analysis & Simulation -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Chart: Evolution Temporelle (Interactive) -->
                <div class="card p-5 lg:col-span-2">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="font-bold text-gray-700 flex items-center">
                            <i class="far fa-calendar-alt mr-2 text-blue-500"></i> Analyse Saisonni√®re : Le "Ciseau" Prix/Volume
                        </h4>
                        <select class="text-xs border-gray-300 rounded shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" onchange="updateChartMetric(this.value)">
                            <option value="revenue">Comparatif CA (‚Ç¨)</option>
                            <option value="transactions">Comparatif Volume (Nb)</option>
                        </select>
                    </div>
                    <div class="relative h-80">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>

                <!-- Simulator: The "What If" Machine -->
                <div class="card p-5 bg-gray-900 text-white relative overflow-hidden">
                    <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-green-500 rounded-full opacity-20 blur-xl"></div>
                    
                    <h4 class="font-bold text-lg mb-1 flex items-center z-10 relative">
                        <i class="fas fa-calculator mr-2 text-green-400"></i> Simulateur d'Impact
                    </h4>
                    <p class="text-xs text-gray-400 mb-6 z-10 relative">Ajustez le Panier Moyen pour voir l'impact sur le CA Global.</p>

                    <div class="space-y-6 z-10 relative">
                        <!-- Slider Panier Moyen -->
                        <div>
                            <div class="flex justify-between text-xs mb-2">
                                <span class="text-gray-400">Panier Actuel</span>
                                <span class="font-bold text-green-400" id="sim-aov-display">661 ‚Ç¨</span>
                            </div>
                            <input type="range" min="600" max="800" value="661" id="slider-aov" oninput="simulateRevenue()">
                            <div class="flex justify-between text-[10px] text-gray-500 mt-1">
                                <span>600‚Ç¨</span>
                                <span>Objectif 720‚Ç¨</span>
                                <span>800‚Ç¨</span>
                            </div>
                        </div>

                        <!-- Result Box -->
                        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 text-center">
                            <p class="text-xs text-gray-400 uppercase">Projection Chiffre d'Affaires</p>
                            <h3 class="text-3xl font-bold text-white mt-1" id="sim-revenue-display">89.0 M‚Ç¨</h3>
                            <p class="text-xs mt-2" id="sim-diff-display">Impact: 0 M‚Ç¨</p>
                        </div>

                        <div class="text-[10px] text-gray-500 italic text-center">
                            Bas√© sur un volume constant de 134,590 transactions.
                        </div>
                        
                        <button onclick="resetSimulator()" class="w-full py-2 bg-gray-700 hover:bg-gray-600 rounded text-xs text-white transition font-semibold">
                            R√©initialiser
                        </button>
                    </div>
                </div>
            </div>

            <!-- Bottom Section: Detailed Breakdown -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- Performance Parcs (Matrix View) -->
                <div class="card p-5">
                    <h4 class="font-bold text-gray-700 mb-4">Matrice de Performance Parcs</h4>
                    <div class="overflow-y-auto h-64 pr-2">
                        <table class="min-w-full text-sm">
                            <thead class="sticky top-0 bg-white">
                                <tr class="text-xs text-gray-500 border-b">
                                    <th class="text-left pb-2">Parc</th>
                                    <th class="text-right pb-2">CA Total</th>
                                    <th class="text-right pb-2">Evol. CA</th>
                                    <th class="text-center pb-2">Statut</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y text-gray-700" id="parks-table-body">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Action Plan (Geo Opportunities) -->
                <div class="card p-5">
                    <h4 class="font-bold text-gray-700 mb-4">Gisements de Croissance (Hors France)</h4>
                    <div class="space-y-4">
                        <!-- Suisse -->
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded border border-gray-100">
                            <div class="flex items-center gap-3">
                                <div class="bg-white p-2 rounded shadow-sm text-lg">üá®üá≠</div>
                                <div>
                                    <p class="font-bold text-sm">Suisse</p>
                                    <p class="text-xs text-gray-500">Panier Moyen: 1 100‚Ç¨ (Est.)</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-red-500 font-bold text-sm">-32% CA</p>
                                <p class="text-[10px] text-gray-400">Potentiel inexploit√©</p>
                            </div>
                        </div>
                        <!-- Luxembourg -->
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded border border-gray-100">
                            <div class="flex items-center gap-3">
                                <div class="bg-white p-2 rounded shadow-sm text-lg">üá±üá∫</div>
                                <div>
                                    <p class="font-bold text-sm">Luxembourg</p>
                                    <p class="text-xs text-gray-500">Taux Conv: 1.08% (Top 1)</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-red-500 font-bold text-sm">-23% CA</p>
                                <p class="text-[10px] text-gray-400">Perte de volume</p>
                            </div>
                        </div>
                        <!-- Belgique -->
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded border border-gray-100">
                            <div class="flex items-center gap-3">
                                <div class="bg-white p-2 rounded shadow-sm text-lg">üáßüá™</div>
                                <div>
                                    <p class="font-bold text-sm">Belgique</p>
                                    <p class="text-xs text-gray-500">Volume stable</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-red-500 font-bold text-sm">-19% CA</p>
                                <p class="text-[10px] text-gray-400">Besoin d'Upsell</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= VIEW: BATTLE PLAN (Hidden by Default) ================= -->
        <div id="view-battle-plan" class="hidden space-y-6">
            
            <div class="bg-indigo-900 text-white rounded-lg p-8 shadow-xl relative overflow-hidden">
                <div class="absolute right-0 top-0 w-64 h-64 bg-indigo-600 rounded-full opacity-20 -mr-16 -mt-16 blur-2xl"></div>
                <h2 class="text-3xl font-bold mb-2 relative z-10">Plan de Bataille : Op√©ration ROI</h2>
                <p class="text-indigo-200 relative z-10 max-w-2xl">Strat√©gie prioritaire pour Emrick. Objectif : S√©curiser la valeur (Panier Moyen) et capitaliser sur les victoires g√©ographiques.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- COL 1: URGENCE VALEUR -->
                <div class="card p-6 border-t-4 border-orange-500 h-full">
                    <div class="mb-4">
                        <span class="bg-orange-100 text-orange-700 px-2 py-1 rounded text-xs font-bold uppercase">Priorit√© 1</span>
                        <h3 class="text-xl font-bold mt-2">Stopper l'H√©morragie de Valeur</h3>
                        <p class="text-sm text-gray-500 mt-1">Le volume est bon, le prix est mauvais. Il faut vendre mieux, pas plus.</p>
                    </div>
                    <div class="space-y-4">
                        <label class="flex items-start cursor-pointer group">
                            <input type="checkbox" class="task-checkbox mt-1 h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                            <div class="ml-3 text-sm">
                                <p class="font-semibold text-gray-800 group-hover:text-indigo-600">Freiner la Promo de Masse</p>
                                <p class="text-gray-500 text-xs">Arr√™ter les -20% g√©n√©ralis√©s. Cibler uniquement les parcs en souffrance (Bois aux Daims).</p>
                                <span class="badge-gain inline-block mt-1 bg-green-100 text-green-700 px-1.5 py-0.5 rounded text-[10px] font-bold">+2.5M‚Ç¨ CA Est.</span>
                            </div>
                        </label>
                        <hr class="border-gray-100">
                        <label class="flex items-start cursor-pointer group">
                            <input type="checkbox" class="task-checkbox mt-1 h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                            <div class="ml-3 text-sm">
                                <p class="font-semibold text-gray-800 group-hover:text-indigo-600">Activer l'Upsell Syst√©matique</p>
                                <p class="text-gray-500 text-xs">Pousser les activit√©s & repas DANS le tunnel de r√©servation.</p>
                                <span class="badge-gain inline-block mt-1 bg-green-100 text-green-700 px-1.5 py-0.5 rounded text-[10px] font-bold">Obj. Panier +40‚Ç¨</span>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- COL 2: CONQU√äTE VOISINS -->
                <div class="card p-6 border-t-4 border-blue-500 h-full">
                    <div class="mb-4">
                        <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold uppercase">Priorit√© 2</span>
                        <h3 class="text-xl font-bold mt-2">R√©veiller les Voisins Riches</h3>
                        <p class="text-sm text-gray-500 mt-1">Suisse et Luxembourg convertissent 2x mieux mais on les ignore.</p>
                    </div>
                    <div class="space-y-4">
                        <label class="flex items-start cursor-pointer group">
                            <input type="checkbox" class="task-checkbox mt-1 h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                            <div class="ml-3 text-sm">
                                <p class="font-semibold text-gray-800 group-hover:text-indigo-600">Campagne "Nature" Suisse</p>
                                <p class="text-gray-500 text-xs">Cibler les familles CSP+ suisses avec l'offre "Trois-For√™ts" (proximit√©).</p>
                                <span class="badge-gain inline-block mt-1 bg-green-100 text-green-700 px-1.5 py-0.5 rounded text-[10px] font-bold">ROI Potentiel > 8</span>
                            </div>
                        </label>
                        <hr class="border-gray-100">
                        <label class="flex items-start cursor-pointer group">
                            <input type="checkbox" class="task-checkbox mt-1 h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                            <div class="ml-3 text-sm">
                                <p class="font-semibold text-gray-800 group-hover:text-indigo-600">Retargeting Luxembourg</p>
                                <p class="text-gray-500 text-xs">R√©activer les anciens clients Lux avec offre exclusive (Panier > 1000‚Ç¨).</p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- COL 3: OFFENSIVE PRODUIT -->
                <div class="card p-6 border-t-4 border-green-500 h-full">
                    <div class="mb-4">
                        <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold uppercase">Priorit√© 3</span>
                        <h3 class="text-xl font-bold mt-2">Lancement Landes de Gascogne</h3>
                        <p class="text-sm text-gray-500 mt-1">Copier ce qui marche aux Trois-For√™ts pour garantir le succ√®s.</p>
                    </div>
                    <div class="space-y-4">
                        <label class="flex items-start cursor-pointer group">
                            <input type="checkbox" class="task-checkbox mt-1 h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                            <div class="ml-3 text-sm">
                                <p class="font-semibold text-gray-800 group-hover:text-indigo-600">Mirroring Marketing</p>
                                <p class="text-gray-500 text-xs">Utiliser les visuels/arguments "Immersion Nature" qui cartonnent sur Trois-For√™ts.</p>
                            </div>
                        </label>
                        <hr class="border-gray-100">
                        <label class="flex items-start cursor-pointer group">
                            <input type="checkbox" class="task-checkbox mt-1 h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                            <div class="ml-3 text-sm">
                                <p class="font-semibold text-gray-800 group-hover:text-indigo-600">Pilotage ROI par Levier</p>
                                <p class="text-gray-500 text-xs">Ne plus regarder le ROI global. Couper les leviers √† ROI < 2 pour financer le lancement.</p>
                            </div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Warning Zone -->
            <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded shadow-sm">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-red-500"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-red-700">
                            <span class="font-bold">Point de vigilance :</span> Le Bois aux Daims est en chute libre (-32% CA). Il ne faut pas que le lancement des Landes de Gascogne cannibalise ce parc d√©j√† fragile. Pr√©voir une offre de relance sp√©cifique pour ce domaine.
                        </p>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <!-- DATA & LOGIC -->
    <script>
        // --- 1. DATASETS (Simulated from PDF context) ---
        // Context: "N" is 2019-2020, "N-1" is 2018-2019.
        // Seasonality Pattern: Peak in Jan (Booking Season), Dip in Spring, Peak in Summer.
        
        const dataGlobal = {
            revenue: { current: 89.03, prev: 96.28, pct: -7.5 },
            transactions: { current: 134590, prev: 129879, pct: +3.6 },
            aov: { current: 661, prev: 741, pct: -11 }
        };

        const dataFrance = {
            revenue: { current: 83.04, prev: 87.84, pct: -5.5 },
            transactions: { current: 128022, prev: 121301, pct: +5.5 },
            aov: { current: 649, prev: 724, pct: -10 }
        };

        const dataInter = {
            revenue: { current: 5.99, prev: 8.44, pct: -29 },
            transactions: { current: 6568, prev: 8578, pct: -23 },
            aov: { current: 911, prev: 983, pct: -7 }
        };

        // Monthly Trend Data (Simulated Curve based on generic travel seasonality & specific drops mentioned)
        const months = ['Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep'];
        
        // Revenue Curves (M‚Ç¨)
        const revenueTrendCurrent = [5.5, 4.2, 5.8, 12.5, 8.2, 3.5, 4.0, 5.2, 7.8, 9.5, 10.2, 6.5]; // Dip in March (Covid context hinted in dates?)
        const revenueTrendPrev =    [6.0, 5.0, 6.2, 11.0, 7.5, 6.8, 7.2, 8.0, 9.0, 10.5, 11.0, 7.0];

        // Transactions Curves (x1000) - Simulated for the view
        const transactionsTrendCurrent = [8.5, 6.5, 9.0, 19.5, 12.5, 5.5, 6.0, 8.0, 12.0, 14.5, 15.5, 9.5];
        const transactionsTrendPrev =    [8.0, 7.0, 8.5, 15.0, 10.5, 9.5, 10.0, 11.0, 12.5, 14.0, 15.0, 9.0];


        // Park Data
        const parkData = [
            { name: "Les Bois-Francs", ca: "6.0 M‚Ç¨", evol: 60, status: "Top" },
            { name: "Les Trois For√™ts", ca: "7.9 M‚Ç¨", evol: 25, status: "Top" },
            { name: "Le Lac d'Ailette", ca: "4.7 M‚Ç¨", evol: -21, status: "Flop" },
            { name: "Villages Nature", ca: "4.7 M‚Ç¨", evol: -20, status: "Flop" },
            { name: "Le Bois aux Daims", ca: "9.2 M‚Ç¨", evol: -32, status: "Flop" }
        ];

        // --- 2. LOGIC: VIEW SWITCHER ---
        let currentScope = 'global';

        function updateView(scope) {
            
            // Handle Tab Switching Logic
            const dashboardView = document.getElementById('view-dashboard');
            const planView = document.getElementById('view-battle-plan');
            const planBtn = document.getElementById('btn-plan');
            
            // Reset filters active state
            document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));

            if (scope === 'plan') {
                // Show Plan, Hide Dashboard
                dashboardView.classList.add('hidden');
                planView.classList.remove('hidden');
                
                // Style the Plan button specially or just keep it highlighted
                planBtn.classList.add('bg-indigo-100', 'text-indigo-800');
            } else {
                // Show Dashboard, Hide Plan
                dashboardView.classList.remove('hidden');
                planView.classList.add('hidden');
                planBtn.classList.remove('bg-indigo-100', 'text-indigo-800'); // Reset plan button style if needed

                // Set Active Filter Button
                currentScope = scope;
                document.getElementById(`btn-${scope}`).classList.add('active');

                // Update Data
                let data;
                if (scope === 'global') data = dataGlobal;
                else if (scope === 'france') data = dataFrance;
                else data = dataInter;

                // Update Cards
                document.getElementById('kpi-revenue').innerText = data.revenue.current.toFixed(2) + " M‚Ç¨";
                document.getElementById('kpi-transactions').innerText = data.transactions.current.toLocaleString('fr-FR');
                document.getElementById('kpi-aov').innerText = data.aov.current + " ‚Ç¨";
                
                // Recalculate Simulator Base
                document.getElementById('slider-aov').value = data.aov.current;
                simulateRevenue(); 
            }
        }

        // --- 3. LOGIC: SIMULATOR ---
        function simulateRevenue() {
            let data;
            if (currentScope === 'global') data = dataGlobal;
            else if (currentScope === 'france') data = dataFrance;
            else data = dataInter;

            const baseTransactions = data.transactions.current;
            const newAOV = document.getElementById('slider-aov').value;
            const currentAOV = data.aov.current;

            const projectedRevenue = (baseTransactions * newAOV) / 1000000; // In M‚Ç¨
            const difference = projectedRevenue - data.revenue.current;

            // Update UI
            document.getElementById('sim-aov-display').innerText = newAOV + " ‚Ç¨";
            document.getElementById('sim-revenue-display').innerText = projectedRevenue.toFixed(1) + " M‚Ç¨";
            
            const diffEl = document.getElementById('sim-diff-display');
            if(difference > 0) {
                diffEl.innerText = `Impact: +${difference.toFixed(2)} M‚Ç¨`;
                diffEl.className = "text-xs mt-2 text-green-400 font-bold";
            } else if (difference < 0) {
                diffEl.innerText = `Impact: ${difference.toFixed(2)} M‚Ç¨`;
                diffEl.className = "text-xs mt-2 text-red-400 font-bold";
            } else {
                diffEl.innerText = "Impact: 0 M‚Ç¨";
                diffEl.className = "text-xs mt-2 text-gray-400";
            }
        }

        function resetSimulator() {
            let data;
            if (currentScope === 'global') data = dataGlobal;
            else if (currentScope === 'france') data = dataFrance;
            else data = dataInter;
            
            document.getElementById('slider-aov').value = data.aov.current;
            simulateRevenue();
        }

        // --- 4. LOGIC: CHARTS ---
        let trendChartInstance = null;

        function initCharts() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            trendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'N (2019-2020)',
                            data: revenueTrendCurrent,
                            borderColor: '#10B981', // Green
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'N-1 (2018-2019)',
                            data: revenueTrendPrev,
                            borderColor: '#9CA3AF', // Gray
                            borderDash: [5, 5],
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Revenus (M‚Ç¨)' } }
                    }
                }
            });
        }

        // NEW FUNCTION: Updates the chart data based on the selected dropdown value
        function updateChartMetric(metric) {
            if (!trendChartInstance) return;

            if (metric === 'revenue') {
                trendChartInstance.data.datasets[0].data = revenueTrendCurrent;
                trendChartInstance.data.datasets[1].data = revenueTrendPrev;
                trendChartInstance.options.scales.y.title.text = 'Revenus (M‚Ç¨)';
            } else {
                trendChartInstance.data.datasets[0].data = transactionsTrendCurrent;
                trendChartInstance.data.datasets[1].data = transactionsTrendPrev;
                trendChartInstance.options.scales.y.title.text = 'Transactions (x1000)';
            }
            trendChartInstance.update();
        }

        // --- 5. LOGIC: PARKS TABLE ---
        function renderParksTable() {
            const tbody = document.getElementById('parks-table-body');
            tbody.innerHTML = '';

            parkData.forEach(park => {
                const isPositive = park.evol > 0;
                const colorClass = isPositive ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50';
                const icon = isPositive ? 'fa-arrow-up' : 'fa-arrow-down';
                const statusBadge = isPositive 
                    ? '<span class="px-2 py-1 rounded-full bg-green-100 text-green-700 text-xs font-bold">Leader</span>'
                    : '<span class="px-2 py-1 rounded-full bg-red-100 text-red-700 text-xs font-bold">Alerte</span>';

                const row = `
                    <tr class="hover:bg-gray-50 border-b last:border-0">
                        <td class="py-3 font-medium text-gray-800">${park.name}</td>
                        <td class="py-3 text-right text-gray-500 font-mono">${park.ca}</td>
                        <td class="py-3 text-right">
                            <span class="${colorClass} px-2 py-1 rounded text-xs font-bold">
                                <i class="fas ${icon} mr-1"></i>${Math.abs(park.evol)}%
                            </span>
                        </td>
                        <td class="py-3 text-center">${statusBadge}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // Initialize
        window.onload = function() {
            updateView('global');
            initCharts();
            renderParksTable();
        };

    </script>
</body>
</html>
